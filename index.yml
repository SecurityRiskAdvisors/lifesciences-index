Command and Control:
- block:
  - SMB connections are blocked by  host-based firewalls
  controls:
  - UEBA
  - ID/PS
  - Hardening
  description: Establish and communicate over an SMB C2 channel on the internal network
  detect:
  - Anomalous SMB communications are detected by UEBA and/or the IDS
  logs:
  - network
  - winevent:configured
  metadata:
    isv: 1
    tactic: TA0011
    tid: T1095
    x_tools:
    - Cobalt Strike
  name: SMB C2 Channel
  prerequisites:
  - logon_rights
- block:
  - Connections to known malicious domains/IPs are blocked
  - Connections using known C2 traffic signatures/characteristics are blocked
  controls:
  - SIEM
  - ID/PS
  - Firewall
  description: Establish and communicate over an HTTPS C2 channel that mimics legitimate
    SolarWinds Orion Improvement Program traffic
  detect:
  - Connections to known malicious domains/IPs are detected
  - Connections with suspicious characteristics (e.g. first seen in environment, low
    domain age, weak/unknown reputation, bad/unknown categorization) generate alerts
    in the SIEM or network security controls
  - Connections using known C2 traffic signatures/characteristics are detected
  logs:
  - network
  metadata:
    isv: 1
    tactic: TA0011
    tid: T1071.001
    x_tools:
    - Cobalt Strike
  name: HTTPS C2 Channel with OIP Profile
- block:
  - Connections to known malicious domains/IPs are blocked
  - Connections using known C2 traffic signatures/characteristics are blocked
  controls:
  - ID/PS
  - Firewall
  - SIEM
  description: 'Establish and communicate over an HTTP C2 channel

    '
  detect:
  - Connections to known malicious domains/IPs are detected
  - Signatues for known bad tools are detected by network security controls such as
    an ID/PS
  - Connections with suspicious characteristics (e.g. first seen in environment, low
    domain age, weak/unknown reputation, bad/unknown categorization) generate alerts
    in the SIEM or network security controls
  - Connections using known C2 traffic signatures/characteristics are detected
  logs:
  - network
  metadata:
    isv: 1
    tactic: TA0011
    tid: T1071.001
  name: HTTP C2 Channel
  platforms:
  - windows
  - macos
  - linux
- block:
  - Tor network traffic blocked outright by network security controls
  controls:
  - Firewall
  - ID/PS
  description: 'Establish connection over Tor network from a compromised endpoint

    '
  detect:
  - Tor network traffic detected by behavioral analytics or firewall
  logs:
  - network
  metadata:
    isv: 1
    tactic: TA0011
    tid: T1090.003
  name: Communications over Tor Network
Credential Access:
- block:
  - null
  controls:
  - SIEM
  - UEBA
  description: Perform a kerberoast attack by requesting Kerberos tickets for accounts
    with service principal names
  detect:
  - Alert on a high volume of 4769 ticket request events from a single source
  - Configure a honey account with a service principal name set and alert on any ticket
    request for that account
  guidance:
  - beacon> execute-assembly rubeus.exe kerberoast
  logs:
  - winevent:configured
  metadata:
    isv: 1
    tactic: TA0006
    tid: T1558.003
    x_tools:
    - Cobalt Strike
    - Rubeus
  name: Kerberoast
- block:
  - Suspicious process access is blocked by EDR or other endpoint security tool
  - Attempts to access lsass.exe process memory are blocked via Credential Guard
  controls:
  - EDR
  - SIEM
  description: Extract credentials from process memory
  detect:
  - Suspicious process access is detected by EDR or other endpoint security tool
  - Credential dumping tools detected via specific module loads and/or suspicious
    process access activity in the SIEM
  guidance:
  - mimikatz> privilege::debug sekurlsa::logonpasswords
  logs:
  - edr:telemetry
  - winevent:configured
  metadata:
    isv: 1
    tactic: TA0006
    tid: T1003.001
    x_tools:
    - Mimikatz
  name: Credential Dumping from Memory
  platforms:
  - windows
  prerequisites:
  - local_admin
- block:
  - null
  controls:
  - SIEM
  - IDS
  description: Extract domain data, such as hashed credentials, from a target domain
    controller using replication
  detect:
  - Alert on DRSUAPI RPC traffic originating from a non-Domain Controller source using
    network security tools or a SIEM
  - Alert on Active Directory object access event logs that contain replication rights
    from a non-Domain Controller
  guidance:
  - beacon> dcsync {{ domain_fqdn }} {{ domain}}\{{ user }}
  logs:
  - winevent:configured
  - network
  metadata:
    isv: 1
    tactic: TA0006
    tid: T1003.006
    x_foo:
    - Mimikatz
    - Cobalt Strike
  name: Replicate Domain Data using DCSync
  platforms:
  - windows
  prerequisites:
  - domain_admin
- block:
  - null
  controls:
  - SIEM
  description: Extract the SAML signing certificate from ADFS. This certificate is
    used to sign SAML messages from ADFS during SSO sign-in flows. Once exported,
    an attacker can use it to forge valid SAML messages to federated application and
    masquerade as any user in those application.
  detect:
  - Configure a SACL on the ADFS Policy Story DKM group then alert on anomalous object
    access events containing properties related to the SAML materials
  - https://techcommunity.microsoft.com/t5/azure-sentinel/solarwinds-post-compromise-hunting-with-azure-sentinel/ba-p/1995095
  guidance:
  - cmd> ADFSdump.exe
  logs:
  - application
  metadata:
    isv: 1
    tactic: TA0006
    tid: T1552.004
    x_tools:
    - https://github.com/fireeye/adfsdump
  name: (Optional) Export SAML Certificate from ADFS
  prerequisites:
  - adfs_admin
Defense Evasion:
- block:
  - null
  controls:
  - SIEM
  - EDR
  description: Modify a service associated with a security tool running on the system
    to not start on system start
  detect:
  - Suspicious process execution is detected by EDR or other endpoint security tool,
    or alerted in SIEM based on process creation events
  - Alert on the registry change event for services related to critical functions
    like security tools using native Windows logs and/or endpoint security tool telemetry
  guidance:
  - cmd> reg add HKLM\system\currentcontrolset\services\{{ service }} /v Start /t
    REG_DWORD /d 4
  logs:
  - winevent:configured
  - edr:telemetry
  metadata:
    isv: 1
    tactic: TA0005
    tid: T1562.004
  name: Disable Security Tool Service Autostart via Registry
  platforms:
  - windows
  prerequisites:
  - local_admin
- block:
  - Suspicious process execution is blocked by EDR or other endpoint security tool
  - Payload on disk deleted/quarantined by antivirus or other endpoint security tool
  controls:
  - EDR
  - Antivirus
  description: Create a malicious patch (.msp) file containing a DLL payload and install
    it to trigger the DLL execution
  detect:
  - Suspicious process execution is detected by EDR or other endpoint security tool,
    or alerted in SIEM based on process creation events
  - Payload on disk triggers an alert in EDR or other endpoint security tool
  guidance:
  - cmd> msiexec.exe /p {{ patch_file }} REINSTALL=ALL REINSTALLMODE=omus /qn
  logs:
  - edr:telemetry
  - process_create
  metadata:
    isv: 1
    tactic: TA0005
    tid: T1218
  name: Execute DLL via MSP Installation
  platforms:
  - windows
- block:
  - null
  controls:
  - SIEM
  description: Rename the external tool "adfind.exe" to csrss.exe to avoid brittle
    command-line based detections
  detect:
  - Detect file write events to destinations containing known Windows components
  guidance:
  - cmd> rename adfind.exe csrss.exe
  logs:
  - winevent:configured
  - edr:telemetry
  metadata:
    isv: 1
    tactic: TA0005
    tid: T1036.005
  name: Rename adfind.exe to csrss.exe
  platforms:
  - windows
- block:
  - Suspicious process execution is blocked by EDR or other endpoint security tool
  controls:
  - SIEM
  - EDR
  description: Disable advanced auditing features on the endpoint using the native
    utility "auditpol.exe"
  detect:
  - Suspicious process execution is detected by EDR or other endpoint security tool,
    or alerted in SIEM based on process creation events
  - Changes to audit policy configurations are detected in the SIEM via 4719 event
    ids
  guidance:
  - "cmd> auditpol /set /category:\u201DDetailed Tracking\u201D /success:disable /failure:disable"
  logs:
  - edr:telemetry
  - process_create
  metadata:
    isv: 1
    tactic: TA0005
    tid: T1562.002
  name: Disable Windows Logging with auditpol.exe
  platforms:
  - windows
  prerequisites:
  - local_admin
- block:
  - null
  controls:
  - EDR
  - SIEM
  description: Disable a service associated with a security tool running on the system
  detect:
  - Alert on the service stop event for services related to critical functions like
    security tools using native Windows logs and/or endpoint security tool telemetry
  - Suspicious process execution is detected by EDR or other endpoint security tool,
    or alerted in SIEM based on process creation events
  guidance:
  - cmd> sc stop {{ service }}
  logs:
  - winevent:configured
  - edr:telemetry
  metadata:
    isv: 1
    tactic: TA0005
    tid: T1562.001
  name: Disable Security Tool Service
  prerequisites:
  - local_admin
- block:
  - null
  controls:
  - SIEM
  - EDR
  description: Block UDP ports 53 (DNS) and 137 (NetBIOS) on the Windows firewall
    using netsh.exe.
  detect:
  - Suspicious process execution is detected by EDR or other endpoint security tool,
    or alerted in SIEM based on process creation events
  - Anomalous firewall changes are detected in the SIEM using endpoint security tool
    telemetry and/or Windows event ID 4948/4947/4946
  guidance:
  - "cmd> netsh advfirewall firewall add rule name=\u201D{{ rule_name }}\u201D protocol=UDP\
    \ dir=out localport=137 action=block"
  - "cmd> netsh advfirewall firewall add rule name=\u201D{{ rule_name }}\u201D protocol=UDP\
    \ dir=out localport=53 action=block"
  logs:
  - winevent:configured
  - edr:telemetry
  metadata:
    isv: 1
    tactic: TA0005
    tid: T1562.004
  name: Block Outbound UDP with netsh
  platforms:
  - windows
  prerequisites:
  - local_admin
- block:
  - Suspicious process execution is blocked by EDR or other endpoint security tool
  controls:
  - EDR
  description: 'Inject into a process using VirtualAlloc, WriteProcessMemory, and
    CreateRemoteThread. For injection targets, ignore crss.exe, explorer.exe, and
    lsass.exe as well as processes running as SYSTEM. Prefer trusted system processes
    like rdpclip.exe.

    '
  detect:
  - Suspicious process execution is detected by EDR or other endpoint security tool
  guidance:
  - beacon> inject {{ pid }}
  - set proper API order in profile
  logs:
  - edr:telemetry
  metadata:
    isv: 1
    tactic: TA0005
    tid: T1055.002
    x_tools:
    - Cobalt Strike
  name: Process Injection via CreateRemoteThread
  platforms:
  - windows
- block:
  - null
  controls:
  - EDR
  - SIEM
  description: 'Stop multiple processes on the endpoint, including Office and Security
    tool processes, using taskkill and/or net

    '
  detect:
  - Use Windows process and service audit capabilities or EDR telemetry to detect
    a user stopping multiple processes/services
  guidance:
  - taskkill /im {{ pid }}
  - net stop {{ name }}
  logs:
  - edr:telemetry
  - winevent:configured
  metadata:
    isv: 1
    tactic: TA0005
    tid: T1562.001
  name: Kill Multiple Processes
  platforms:
  - windows
  prerequisites:
  - local_admin
- block:
  - Suspicious process execution is blocked by EDR or other endpoint security tool
  controls:
  - SIEM
  - EDR
  description: 'Modify the permissions of a mounted drive to allow the ransomware
    process to modify files on that drive

    '
  detect:
  - Use Windows advanced auditing capabilities to monitor for bulk changes to DACLs
    (event id 4670) and alert on suspicious events in the SIEM
  guidance:
  - cmd> icacls "{{ drive_letter }}:\*" /grant Everyone:F /T /C /Q
  logs:
  - winevent:configured
  - edr:telemetry
  metadata:
    isv: 1
    tactic: TA0005
    tid: T1222.001
  name: Modify Mounted Drive Permissions
  platforms:
  - windows
  prerequisites:
  - local_admin
Discovery:
- controls:
  - EDR
  - SIEM
  description: Enumerated installed security tools
  detect:
  - Suspicious process execution/behavior is detected by EDR or other endpoint security
    tool, or alerted in SIEM based on process creation events
  guidance:
  - cmd> wmic.exe /namespace:\\root\securitycenter2 path antivirusproduct get
  - beacon> execute-assembly Seatbelt.exe AntiVirus
  - beacon> AV_Query
  - beacon> edr_query localhost {{ arch }}
  logs:
  - process_create
  metadata:
    isv: 1
    tactic: TA0007
    tid: T1518.001
    x_tool_links:
    - https://github.com/harleyQu1nn/AggressorScripts/blob/master/EDR.cna
    - https://github.com/harleyQu1nn/AggressorScripts/blob/master/AVQuery.cna
    x_tools:
    - Cobalt Strike
  name: Security Tool Discovery
  platforms:
  - windows
- block:
  - Suspicious process execution is blocked by EDR or other endpoint security tool
  controls:
  - EDR
  - UEBA
  - SIEM
  description: Using the tool "adfind.exe" (renamed to "csrss.exe"), enumerate domain
    information like domain users, groups, etc.
  detect:
  - Suspicious process execution is detected by EDR or other endpoint security tool,
    or alerted in SIEM based on process creation events
  - A source generating a large number of object access events (e.g. event id 4662)
    is detected by the SIEM after configuring auditing on domain objects
  guidance:
  - "cmd> csrss.exe -h {{ domain }} -f (name=\u201DDomain Admins\u201D) member -list\
    \ | csrss.exe -h {{ domain }} -f objectcategory=* > .\\output.log"
  - cmd> csrss.exe -h {{ domain }} -sc u:* > .\output.log
  logs:
  - network
  - winevent:configured
  metadata:
    isv: 1
    tactic: TA0007
    tid: T1087.002
  name: Enumerate Domain Information using Renamed adfind.exe
  platforms:
  - windows
- controls:
  - SIEM
  description: Enumerate running processes via tasklist
  detect:
  - Suspicious process execution is detected by EDR or other endpoint security tool,
    or alerted in SIEM based on process creation events
  guidance:
  - cmd> tasklist.exe
  logs:
  - process_create
  metadata:
    isv: 1
    tactic: TA0007
    tid: T1057
  name: Process Discovery via Tasklist
  platforms:
  - windows
  - macos
  - linux
Execution:
- block:
  - Payload on disk deleted/quarantined by antivirus or other endpoint security tool
  - Suspicious process execution is blocked by EDR or other endpoint security tool
  controls:
  - Antivirus
  - EDR
  description: Execute a VBScript payload using wscript.exe by setting the execution
    command as the image file execution option for dllhost.exe then waiting for dllhost.exe
    to launch by itself or by manually starting it
  detect:
  - Payload on disk triggers an alert in EDR or other endpoint security tool
  - Suspicious process execution is detected by EDR or other endpoint security tool,
    or alerted in SIEM based on process creation events
  guidance:
  - cmd> reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image
    File Execution Options\dllhost.exe" /v Debugger /f /d "wscript.exe {{ vbs_payload
    }}"
  logs:
  - winevent:configured
  - edr:telemetry
  metadata:
    isv: 1
    tactic: TA0002
    tid: T1546.012
  name: VBScript Execution using Image File Execution Options (IFEO)
  platforms:
  - windows
  prerequisites:
  - local_admin
- block:
  - Suspicious process execution/behavior is blocked by EDR or other endpoint security
    tool
  - Payload on disk deleted/quarantined by antivirus or other endpoint security tool
  controls:
  - Antivirus
  - EDR
  description: Execute a DLL function directly using rundll32 as an encoded PowerShell
    command
  detect:
  - Suspicious process execution/behavior is detected by EDR or other endpoint security
    tool, or alerted in SIEM based on process creation events
  - Payload on disk triggers an alert in EDR or other endpoint security tool
  guidance:
  - cmd> powershell -nop -exec bypass -encodedcommand {{ encoded_command }}
  - encoded_command -> rundll32 {{ dll_payload }} {{ dll_export }}"
  logs:
  - edr:telemetry
  - process_create
  metadata:
    isv: 1
    tactic: TA0002
    tid: T1218.001
  name: Execution using PowerShell and Rundll32
  platforms:
  - windows
- block:
  - null
  controls:
  - SIEM
  description: Create a named pipe object on the system to prevent concurrent payload
    executions
  detect:
  - Use Windows auditing capabilities to monitor access attempts for specific securable
    objects, such as named pipes
  guidance:
  - ps> New-Object System.IO.Pipes.NamedPipeServerStream("583da945-62af-10e8-4902-a8f205c72b2e",
    "Out")
  logs:
  - winevent:configured
  metadata:
    isv: 1
    tactic: TA0002
    tid: T1480
  name: Create Named Pipe to Prevent Concurrent Execution
  platforms:
  - windows
Impact:
- block:
  - Suspicious process execution is blocked by EDR or other endpoint security tool
  - Executable on disk deleted/quarantined by antivirus or other endpoint security
    tool
  controls:
  - SIEM
  - EDR
  description: 'Encrypt a large amount of files on disk to simulate ransomware behavior

    '
  detect:
  - Suspicious process execution is detected by EDR or other endpoint security tool
  - A large amount of file deletion and creations and/or file creations with known
    ransomware extensions are alerted on in the SIEM
  guidance:
  - '{{ ransomware_binary }}'
  logs:
  - winevent:configured
  - edr:telemetry
  metadata:
    isv: 1
    tactic: TA0040
    tid: T1486
  name: Encrypt a Large Amount of Files
- block:
  - Suspicious process execution is blocked by EDR or other endpoint security tool
  controls:
  - EDR
  - SIEM
  description: 'Modify the Windows boot configuration using bcdedit to prevent automatic
    recovery features

    '
  detect:
  - Detect suspicious changes to boot configurations via process creations logs (e.g.
    4688) and boot configuration logs (e.g. 4826)
  guidance:
  - cmd> bcdedit /set {default} bootstatuspolicy ignoreallfailures
  logs:
  - process_create
  - edr:telemetry
  metadata:
    isv: 1
    tactic: TA0040
    tid: T1490
  name: bcdedit Ignore Failures
  platforms:
  - windows
  prerequisites:
  - local_admin
- block:
  - Suspicious process execution is blocked by EDR or other endpoint security tool
  controls:
  - EDR
  - SIEM
  description: 'Delete volume shadow copies with wmic.exe to prevent file recovery

    '
  detect:
  - Use Windows file system auditing capabilities to monitor access attempts for specific
    files and/or paths (e.g. paths related to Volume Shadow Services)
  guidance:
  - cmd> wmic.exe shadowcopy delete
  logs:
  - process_create
  - edr:telemetry
  - winevent:configured
  metadata:
    isv: 1
    tactic: TA0040
    tid: T1490
  name: Delete Shadows with wmic
  platforms:
  - windows
  prerequisites:
  - local_admin
- block:
  - Suspicious process execution is blocked by EDR or other endpoint security tool
  controls:
  - EDR
  - SIEM
  description: 'Delete volume shadow copies with vssadmin.exe to prevent file recovery

    '
  detect:
  - Use Windows file system auditing capabilities to monitor access attempts for specific
    files and/or paths (e.g. paths related to Volume Shadow Services)
  guidance:
  - cmd> vssadmin.exe delete shadows /all /quiet
  logs:
  - process_create
  - edr:telemetry
  - winevent:configured
  metadata:
    isv: 1
    tactic: TA0040
    tid: T1490
  name: Delete Shadows with vssadmin
  platforms:
  - windows
  prerequisites:
  - local_admin
- block:
  - Suspicious process execution is blocked by EDR or other endpoint security tool
  controls:
  - EDR
  - SIEM
  description: 'Modify the Windows boot configuration using bcdedit to prevent automatic
    recovery features

    '
  detect:
  - Detect suspicious changes to boot configurations via process creations logs (e.g.
    4688) and boot configuration logs (e.g. 4826)
  guidance:
  - cmd> bcdedit /set {default} recoveryenabled No
  logs:
  - process_create
  - edr:telemetry
  metadata:
    isv: 1
    tactic: TA0040
    tid: T1490
  name: bcdedit Disable Recovery
  platforms:
  - windows
  prerequisites:
  - local_admin
Lateral Movement:
- block:
  - Suspicious process execution/behavior is blocked by EDR or other endpoint security
    tool
  - Payload on disk deleted/quarantined by antivirus or other endpoint security tool
  controls:
  - EDR
  - Antivirus
  description: Move laterally to another system by using WMI and rundll32
  detect:
  - Suspicious process execution/behavior is detected by EDR or other endpoint security
    tool, or alerted in SIEM based on process creation events
  - Payload on disk triggers an alert in EDR or other endpoint security tool
  guidance:
  - "cmd> wmic /node:\"{{ target }}\" process call create \u201Crundll32 {{ dll_payload\
    \ }} {{ dll_export }}\""
  logs:
  - edr:telemetry
  - process_create
  metadata:
    isv: 1
    tactic: TA0008
    tid: T1021.003
  name: Lateral Movement via WMI
  platforms:
  - windows
  prerequisites:
  - logon_rights
- block:
  - Suspicious process execution/behavior is blocked by EDR or other endpoint security
    tool
  - Payload on disk deleted/quarantined by antivirus or other endpoint security tool
  controls:
  - EDR
  - Antivirus
  description: Move laterally to another system by using WinRM and rundll32
  detect:
  - Suspicious process execution/behavior is detected by EDR or other endpoint security
    tool, or alerted in SIEM based on process creation events
  - Payload on disk triggers an alert in EDR or other endpoint security tool
  guidance:
  - ps> Invoke-Command -ComputerName {{ target }} -ScriptBlock { rundll32 {{ dll_payload
    }} {{ dll_export }} }
  logs:
  - edr:telemetry
  - process_create
  metadata:
    isv: 1
    tactic: TA0008
    tid: T1021.006
  name: Lateral Movement via WinRM
  platforms:
  - windows
  prerequisites:
  - logon_rights
- block:
  - null
  controls:
  - SIEM
  - EDR
  description: Move laterally to another systen by creating a scheduled task on that
    system
  detect:
  - Suspicious process execution is detected by EDR or other endpoint security tool,
    or alerted in SIEM based on process creation events
  - Anomalous remote task creation is detected using native Windows logs (e.g. 4698)
  guidance:
  - "cmd> schtasks /create /F /tn \u201C\\Microsoft\\Windows\\SoftwareProtectionPlatform\\\
    EventCacheManager\u201D /tr {{ command }} /sc ONSTART /ru system /S {{ target\
    \ }}"
  logs:
  - winevent:configured
  metadata:
    isv: 1
    tactic: TA0008
    tid: T1021.003
  name: Lateral Movement via Scheduled Task
  platforms:
  - windows
  prerequisites:
  - logon_rights
- block:
  - Disable Wake-on-LAN on the device
  controls:
  - ID/PS
  - Hardening
  description: 'Wake a remote system using a Wake-on-LAN magic packet in order to
    encrypt its drive(s) remotely

    '
  detect:
  - null
  logs:
  - network
  metadata:
    isv: 1
    tactic: TA0008
    tid: T1021
  name: Wake Remote System using Wake-on-LAN
Persistence:
- block:
  - null
  controls:
  - SIEM
  description: Create a new federation trust in Azure Active Directory to allow for
    the attacker controlled domain to sign SAML tokens
  detect:
  - Use Azure audit logs to alert on anomalous federation setting modification events
  - https://github.com/Azure/Azure-Sentinel/blob/master/Detections/AuditLogs/ADFSDomainTrustMods.yaml
  logs:
  - application
  metadata:
    isv: 1
    tactic: TA0003
    tid: T1484.002
  name: (Optional) Create New Federation Trust
  prerequisites:
  - aad_admin
- block:
  - null
  controls:
  - EDR
  - SIEM
  description: Persist on a system by creating a new service
  detect:
  - Detect suspicious service creation using Windows event id 4697/7045
  guidance:
  - cmd> sc.exe create {{ service_name }} binPath= {{ service_binary }}
  logs:
  - winevent:system
  - winevent:configured
  metadata:
    isv: 1
    tactic: TA0003
    tid: T1543.003
  name: New Windows Service
  platforms:
  - windows
  prerequisites:
  - local_admin
- block:
  - null
  controls:
  - SIEM
  description: In Azure AD, add a new credential to an OAuth application
  detect:
  - Use Azure audit logs to alert on anomalous service principal credential events
  - https://techcommunity.microsoft.com/t5/azure-sentinel/solarwinds-post-compromise-hunting-with-azure-sentinel/ba-p/1995095
  logs:
  - application
  metadata:
    isv: 1
    tactic: TA0003
    tid: T1098.001
  name: In Azure AD, add a new credential to an OAuth application
  prerequisites:
  - aad_admin
- block:
  - Payload on disk deleted/quarantined by antivirus or other endpoint security tool
  - Suspicious process execution is blocked by EDR or other endpoint security tool
  - Anomalous WMI event filter, consumer, and/or filter to consumer binding creation
    is blocked by EDR or other endpoint security tool
  controls:
  - SIEM
  - EDR
  - Antivirus
  description: Establish persistence on a target system by creating a WMI commandlineeventconsumer
    event subscription that launches a dll with rundll32
  detect:
  - Payload on disk triggers an alert in EDR or other endpoint security tool
  - Suspicious process execution is detected by EDR or other endpoint security tool,
    or alerted in SIEM based on process creation events
  - Anomalous WMI event filter, consumer, and/or filter to consumer binding creation
    is detected in the SIEM using endpoint security tool telemetry or native windows
    event ids (ex 5857).
  guidance:
  - cmd> wmic /NAMESPACE:"\\root\subscription" PATH __EventFilter CREATE Name="__timeritem",
    EventNameSpace="root\cimv2",QueryLanguage="WQL", Query="SELECT * FROM __InstanceModificationEvent
    WITHIN 70 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System' AND
    TargetInstance.SystemUpTime >= 300 AND TargetInstance.SystemUpTime < 4400"
  - cmd> wmic /NAMESPACE:"\\root\subscription" PATH CommandLineEventConsumer CREATE
    Name="setpolicytrace", ExecutablePath="C:\Windows\System32\rundll32.exe",CommandLineTemplate="C:\Windows\System32\rundll32.exe
    {{ dll_payload }} {{ dll_export }}"
  - cmd> wmic /NAMESPACE:"\\root\subscription" PATH __FilterToConsumerBinding CREATE
    Filter="__EventFilter.Name=\"__timeritem\"", Consumer="CommandLineEventConsumer.Name=\"setpolicytrace\""
  logs:
  - winevent:configured
  - edr:telemetry
  metadata:
    isv: 1
    tactic: TA0003
    tid: T1546.003
  name: Persist via WMI Event Subscription
  platforms:
  - windows
  prerequisites:
  - local_admin
- block:
  - Suspicious process execution is blocked by EDR or other endpoint security tool
  controls:
  - SIEM
  - EDR
  description: 'Establish persistence execution on an endpoint by configuring a command
    to run on user login

    '
  detect:
  - EDR and/or SIEM rules are configured to detect Windows registry modifications
  guidance:
  - cmd> reg add "HKCU\software\microsoft\windows\currentversion\run" /v "svchos"
    /t REG_SZ /f /d "{{ command }}"
  logs:
  - edr:telemetry
  - winevent:configured
  metadata:
    isv: 1
    tactic: TA0003
    tid: T1547.001
  name: Persist via Registry Run Key
  platforms:
  - windows
Privilege Escalation:
- block:
  - Prevent use of privileges such as SeDebugPrivilege via user rights assignment
    GPO settings
  controls:
  - EDR
  - SIEM
  - Hardening
  description: 'Enable the SeDebugPrivilege privilege on the current token using native
    Windows APIs

    '
  detect:
  - Detect suspicious privilege use in the SIEM using advanced audit logs for sensitive
    privilege use (e.g. 4703)
  guidance:
  - beacon> getprivs
  logs:
  - edr:telemetry
  - winevent:configured
  metadata:
    isv: 1
    tactic: TA0004
    tid: T1134
    x_tools:
    - Cobalt Strike
  name: Enabled Debug Privileges for Token
  platforms:
  - windows
  prerequisites:
  - local_admin